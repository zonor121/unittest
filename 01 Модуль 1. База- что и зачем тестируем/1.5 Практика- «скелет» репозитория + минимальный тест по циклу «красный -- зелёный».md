# Первый автотест в репозитории: “скелет” проекта и цикл «красный → зелёный»

Если тесты не находятся автоматически или импорты ведут себя по‑разному в терминале, IDE и CI, любой следующий шаг в автоматизации будет нестабильным. Поэтому “первый прогон” нужен не ради галочки: он фиксирует **рабочую структуру репозитория** и показывает, что `unittest` действительно умеет собрать и запустить Ваш набор тестов через discovery. В `unittest` discovery устроен так, что тесты загружаются через импорт модулей, а значит структура проекта и импортируемость — часть инфраструктуры тестирования. ([Python documentation][1])

Ниже — практический сценарий от пустой папки до первого зелёного прогона: создаётся минимальная структура, пишется один тест, он падает (“красный”), затем добавляется минимальная реализация, и тест проходит (“зелёный”).

## Контекст: что именно Вы строите и что должно получиться

Цель “скелета” — обеспечить три свойства.

Первое: тесты находятся discovery без ручного перечисления файлов. `unittest` ожидает, что тестовые файлы — импортируемые модули/пакеты, доступные от “верхнего” каталога проекта, и discovery действительно грузит тесты импортом. ([Python documentation][1])

Второе: импорты предсказуемы. Один и тот же `import` должен работать одинаково в терминале и CI, без зависимостей от текущей директории и “случайных” путей в `sys.path`. Практика, которая это усиливает, — **src layout**: исполняемый/импортируемый код отделяется в `src/`, и тогда запуск опирается на установленный пакет (например, editable install), а не на то, что “лежит рядом”. ([Python Packaging][2])

Третье: цикл «красный → зелёный» происходит быстро. Вы запускаете тесты одной командой и сразу видите, что именно сломано: обнаружение, импорт, логика или ожидание.

## Визуальная схема “скелета”: что и где лежит

Ниже — рабочая минимальная структура под `unittest` с src layout. Её можно использовать как шаблон.

```text
qa-unittest-skeleton/
├─ pyproject.toml
├─ src/
│  └─ qautils/
│     ├─ __init__.py
│     └─ math_utils.py
└─ tests/
   ├─ __init__.py
   └─ test_math_utils.py
```

Зачем нужны именно эти элементы:

* `src/qautils/` — пакет приложения (то, что тестируете).
* `tests/` — пакет тестов (то, что запускаете).
* `__init__.py` в каталогах делает их обычными Python‑пакетами, что упрощает импортируемость и работу discovery.
* `pyproject.toml` нужен, чтобы можно было установить проект (в editable режиме) и импортировать пакет из `src/` предсказуемо. В src layout проект “по смыслу” должен быть установлен, иначе код из `src/` не окажется на пути импортов. ([Python Packaging][2])

## Таблица: роль файлов в минимальном репозитории

| Файл/папка                  | Роль                       | Что сломается без этого                                         |
| --------------------------- | -------------------------- | --------------------------------------------------------------- |
| `src/qautils/__init__.py`   | метка пакета               | импорт `qautils` может стать нестабильным                       |
| `src/qautils/math_utils.py` | модуль с кодом             | нечего тестировать                                              |
| `tests/__init__.py`         | делает `tests` пакетом     | discovery и импорты тестов чаще становятся менее предсказуемыми |
| `tests/test_math_utils.py`  | модуль с тестами           | `Ran 0 tests` или пустой прогон                                 |
| `pyproject.toml`            | установка пакета из `src/` | `ModuleNotFoundError: No module named 'qautils'`                |

## Шаг 0: минимальная упаковка (чтобы импорты не “плавали”)

Создайте `pyproject.toml` в корне проекта. Ниже — минимально достаточный конфиг на setuptools, который находит пакеты в `src/`.

```toml
[build-system]
requires = ["setuptools>=68"]
build-backend = "setuptools.build_meta"

[project]
name = "qa-unittest-skeleton"
version = "0.1.0"
requires-python = ">=3.10"

[tool.setuptools.packages.find]
where = ["src"]
```

Это не “для публикации в PyPI”. Это инфраструктура, которая делает src layout рабочим в тестах, потому что код должен быть установлен, чтобы импортироваться. ([Python Packaging][2])

После этого (в виртуальном окружении) установите проект в editable режиме:

```bash
python -m pip install -e .
```

## Шаг 1: создайте “красный” код — минимальный модуль с заведомо неправильным поведением

Создайте файл `src/qautils/math_utils.py`:

```python
# src/qautils/math_utils.py

def add(a: int, b: int) -> int:
    # Намеренно неверная реализация, чтобы получить "красный" тест
    return 0
```

Почему так: если Вы начнёте с отсутствующего файла/функции, первый прогон часто упадёт на импорте (`ImportError`), а не на проверке. Ошибка импорта тоже “красный”, но для первого цикла проще увидеть именно **падение assert**.

## Шаг 2: напишите минимальный тест (один сценарий, один assert)

Создайте файл `tests/test_math_utils.py`:

```python
# tests/test_math_utils.py
import unittest

from qautils.math_utils import add


class TestAdd(unittest.TestCase):
    def test_add_two_numbers(self):
        self.assertEqual(add(2, 3), 5)


if __name__ == "__main__":
    unittest.main()
```

Минимум, который здесь важен:

* класс наследуется от `unittest.TestCase`;
* метод начинается с `test_`, иначе `unittest` не посчитает его тестом; ([Python documentation][1])
* проверка сделана через `assertEqual`, чтобы падение было читаемым.

## Шаг 3: первый запуск набора через discovery (и почему именно так)

Запускайте тесты из **корня проекта**.

Команда (явная и удобная для CI):

```bash
python -m unittest discover -s tests -t . -v
```

Что здесь важно:

* `discover` — режим автопоиска тестов (если аргументы не указывать, `python -m unittest` тоже использует discovery по умолчанию); ([Python documentation][1])
* `-s tests` — искать тесты в `tests/`;
* `-t .` — считать корнем импортов текущий каталог (корень репозитория), чтобы модули тестов были импортируемыми от top-level; ([Python documentation][1])
* `-v` — verbose вывод, чтобы видеть имена тестов.

Ожидаемый результат на этом шаге — **FAIL** (красный), потому что `add(2, 3)` возвращает 0. Примерно так:

```text
test_add_two_numbers (tests.test_math_utils.TestAdd) ... FAIL
AssertionError: 0 != 5
```

Это корректный “красный”: инфраструктура discovery работает, импорты работают, падает именно логика.

## Шаг 4: делаем “зелёный” — минимальное исправление кода

Исправьте `add`:

```python
# src/qautils/math_utils.py

def add(a: int, b: int) -> int:
    return a + b
```

Запустите ту же команду:

```bash
python -m unittest discover -s tests -t . -v
```

Теперь ожидается **OK** (зелёный). В отчёте будет `Ran 1 test` и статус `OK`.

## Что Вы на самом деле проверили этим циклом

Этот короткий red→green прогон проверяет больше, чем кажется:

1. Тесты действительно обнаруживаются. `unittest` нашёл модуль по pattern `test*.py` и смог импортировать его через discovery. ([Python documentation][1])
2. Импорты предсказуемы. Пакет `qautils` импортируется из установленного проекта, а не “как повезёт” из рабочей директории. Это ключевое преимущество src layout: чтобы код запустить, его нужно установить, и это снижает риск случайных импортов. ([Python Packaging][2])
3. Базовая петля разработки настроена: одна команда запуска — один понятный результат.

## Частые поломки на первом прогоне и как их чинить по симптомам

Ниже — таблица, которая экономит время при первом запуске набора.

| Сообщение/симптом                                 | Причина                                                                                      | Исправление                                                                                                                                                            |
| ------------------------------------------------- | -------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Ran 0 tests`                                     | discovery не видит файлы или не импортирует модули тестов                                    | проверьте `-s tests`, pattern `test*.py`, валидность имён файлов, наличие `__init__.py` и запуск из корня; discovery грузит тесты импортом ([Python documentation][1]) |
| `ImportError: Failed to import test module ...`   | тестовый модуль найден, но не импортируется (ошибка в импорте/сайд‑эффект на уровне импорта) | уберите код, который выполняется при импортировании; проверьте пути/пакеты ([Python documentation][1])                                                                 |
| `ModuleNotFoundError: No module named 'qautils'`  | src layout без установки проекта                                                             | выполните `python -m pip install -e .` или переключитесь на flat layout; src layout требует установки ([Python Packaging][2])                                          |
| Тесты находятся, но импортируется “не тот” модуль | конфликт имён, локальная папка перекрывает установленный пакет                               | держите код в `src/`, ставьте в окружение, избегайте совпадений имён с системными пакетами ([Python Packaging][2])                                                     |

## Минимальные соглашения, которые стоит зафиксировать сразу

Практика, которая снижает количество проблем “на ровном месте”: тесты лежат в выделенной папке `tests/`, структура тестов примерно зеркалит структуру пакета. Это упрощает навигацию и запуск. ([Real Python][3])
И отдельно: структура проекта и import‑система — основа тестируемости и расширяемости кода, поэтому фиксация структуры в начале экономит время позже. ([docs.python-guide.org][4])

## Заключение

“Скелет” репозитория под `unittest` — это не эстетика, а инженерная гарантия. Discovery в `unittest` ищет тесты через импорт модулей и ожидает импортируемость от верхнего каталога. ([Python documentation][1])
Src layout делает импорты более честными и предсказуемыми: код отделён в `src/`, и запуск опирается на установленный пакет. ([Python Packaging][2])
Цикл «красный → зелёный» на одном тесте фиксирует, что базовая инфраструктура работает: тест найден, импортирован, выполнен и даёт понятный сигнал.

## Дополнительные материалы

Официальная документация `unittest` (discovery, `TestCase`, правила запуска, параметры `discover`). ([Python documentation][1])
PyPA: сравнение src layout и flat layout и их поведение при запуске кода. ([Python Packaging][2])
Real Python: рекомендации по расположению тестов в `tests/` и базовые соглашения по проектной структуре. ([Real Python][3])
The Hitchhiker’s Guide to Python: раздел про структуру проекта и импорты как основу тестируемости. ([docs.python-guide.org][4])

## Практическое задание

## Цель

Собрать минимальный репозиторий под `unittest` (src layout), выполнить первый прогон discovery и пройти цикл «красный → зелёный» на собственной функции и собственных тестах.

## Задание (шаги)

1. Создайте структуру проекта:

```text
qa-unittest-homework/
├─ pyproject.toml
├─ src/
│  └─ qautils/
│     ├─ __init__.py
│     └─ slugify.py
└─ tests/
   ├─ __init__.py
   └─ test_slugify.py
```

2. Заполните `pyproject.toml` минимальной конфигурацией (можно взять из теории выше, поменяв `name` на `qa-unittest-homework`).

3. Установите проект в editable режиме:

```bash
python -m pip install -e .
```

4. В `src/qautils/slugify.py` создайте функцию-заглушку:

```python
def slugify(text: str) -> str:
    return ""
```

5. В `tests/test_slugify.py` напишите unit‑тесты на функцию `slugify(text)` по спецификации ниже (начните минимум с 3 кейсов). Тесты должны запускаться через `unittest` discovery.

Спецификация `slugify`:

* приводит строку к нижнему регистру;
* пробелы и символ `_` заменяет на `-`;
* удаляет все символы, кроме латинских букв `a-z`, цифр `0-9` и дефиса `-`;
* “схлопывает” подряд идущие дефисы в один;
* обрезает дефисы в начале и в конце;
* для строки, которая после очистки стала пустой, возвращает пустую строку.

Примеры ожидаемого поведения:

* `"Hello, World!"` → `"hello-world"`
* `"  multiple   spaces  "` → `"multiple-spaces"`
* `"Already_Slug"` → `"already-slug"`
* `"---A---B---"` → `"a-b"`
* `"!!!"` → `""`

6. Запустите тесты:

```bash
python -m unittest discover -s tests -t . -v
```

На этом шаге ожидается “красный” прогон.

7. Реализуйте `slugify` так, чтобы все тесты стали зелёными.

8. Запустите тесты повторно и убедитесь, что прогон зелёный (`OK`).

## Подсказки по ключевым частям

Для удаления лишних символов удобно использовать регулярные выражения из `re`. Часто хватает двух проходов: нормализация пробелов/подчёркиваний → очистка по whitelist → схлопывание дефисов.

В тестах держите логику “AAA”: подготовка входа → вызов `slugify` → проверка результата. Старайтесь проверять поведение, а не детали реализации.

Если появляется `ModuleNotFoundError: No module named 'qautils'`, значит проект не установлен в окружение (или установка сделана не в то окружение). В src layout это ожидаемая точка отказа, пока нет `pip install -e .`. ([Python Packaging][2])

## Что проверить перед отправкой (чек-лист)

* Команда `python -m unittest discover -s tests -t . -v` запускается из корня репозитория и завершаетcя `OK`. ([Python documentation][1])
* В `tests/` и `src/qautils/` есть `__init__.py`.
* В тестах нет внешних зависимостей (файлы, сеть, БД, текущее время).
* Тесты не зависят от порядка выполнения (каждый можно запускать отдельно).
* Имена файлов тестов соответствуют pattern `test*.py` (или Вы явно задали другой pattern). ([Python documentation][1])
* Функция `slugify` соответствует спецификации и покрыта тестами на крайние случаи (пустая строка, строка из символов, которые удаляются, множественные пробелы/дефисы).

## Советы по улучшению работы

Добавьте табличные тесты: один тест‑метод, внутри набор входов/ожиданий. Это уменьшает дублирование и делает расширение набора кейсов быстрым.

После зелёного прогона добавьте ещё 2–3 негативных кейса (например, строка с табами, смесь `_` и пробелов, строка с цифрами), чтобы увидеть, как качество спецификации влияет на тестируемость.

Если реализация получилась “кучей замен”, попробуйте сделать её шагами и оставить короткие комментарии, объясняющие именно правила преобразования. Это упростит поддержку.

[1]: https://docs.python.org/3/library/unittest.html?utm_source=chatgpt.com "unittest — Unit testing framework"
[2]: https://packaging.python.org/en/latest/discussions/src-layout-vs-flat-layout/?utm_source=chatgpt.com "src layout vs flat layout - Python Packaging User Guide"
[3]: https://realpython.com/ref/best-practices/project-layout/?utm_source=chatgpt.com "project layout | Python Best Practices"
[4]: https://docs.python-guide.org/writing/structure/?utm_source=chatgpt.com "Structuring Your Project"
